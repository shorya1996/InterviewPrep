import pandas as pd
import json
import re

# === CONFIGURATION ===
input_file = "your_excel_file.xlsx"  # Replace with your actual Excel file path
output_file = "final_output.json"
header_columns_count = 4             # First N columns are headers

# === CAST 1234.0 â†’ 1234 ===
def smart_cast(val):
    if isinstance(val, float) and val.is_integer():
        return int(val)
    return val

# === PARSE COLUMN PATH ===
def parse_path(path):
    path = re.sub(r"\{[^}]*\}", "", path)  # remove type hints like {CurrencyAmount}
    parts = []

    for segment in path.split("."):
        # Check for array with index like field[0]
        indexed = re.match(r"(.*?)\[(\d+)\]$", segment)
        if indexed:
            field_name, idx = indexed.groups()
            parts.append((field_name, "indexed_array", int(idx)))
        elif "[]" in segment:
            parts.append((segment.replace("[]", ""), "array", None))
        else:
            parts.append((segment, "dict", None))
    return parts

# === INSERT VALUE INTO NESTED STRUCTURE SAFELY ===
def insert_nested(root, path, value):
    if not path:
        return value

    key, kind, index = path[0]

    if kind == "indexed_array":
        if key not in root or not isinstance(root[key], list):
            root[key] = []

        idx = index
        while len(root[key]) <= idx:
            root[key].append({})

        # ðŸ”’ Safety: force dict at this position
        if not isinstance(root[key][idx], dict):
            root[key][idx] = {}

        root[key][idx] = insert_nested(root[key][idx], path[1:], value)

    elif kind == "array":
        if key not in root or not isinstance(root[key], list):
            root[key] = []

        if not root[key]:
            root[key].append({})

        # ðŸ”’ Safety
        if not isinstance(root[key][0], dict):
            root[key][0] = {}

        root[key][0] = insert_nested(root[key][0], path[1:], value)

    else:  # dict
        if key not in root or not isinstance(root[key], dict):
            root[key] = {}

        if path[1:]:
            # ðŸ”’ Safety
            if not isinstance(root[key], dict):
                root[key] = {}

            root[key] = insert_nested(root[key], path[1:], value)
        else:
            root[key] = value

    return root

# === MAIN SCRIPT ===
df = pd.read_excel(input_file)
json_requests = []

for _, row in df.iterrows():
    request = {"headers": {}, "body": {}}

    # Headers
    for col in df.columns[:header_columns_count]:
        val = row[col]
        if pd.notna(val):
            request["headers"][col] = smart_cast(val)

    # Body
    body = {}
    for col in df.columns[header_columns_count:]:
        val = row[col]
        if pd.isna(val):
            continue
        val = smart_cast(val)
        path = parse_path(col)
        body = insert_nested(body, path, val)

    request["body"] = body
    json_requests.append(request)

# === OUTPUT ===
with open(output_file, "w") as f:
    json.dump(json_requests, f, indent=2)

print("âœ… JSON written to:", output_file)
