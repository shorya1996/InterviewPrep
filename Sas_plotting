%macro plot_scores_wide(groupvar=, rev_type_list=);

  /* Step 1: Filter data */
  data filtered;
    set your_sql_summary;
    where upcase(rev_type) in (&rev_type_list);
  run;

  /* Step 2: Get unique values for groupvar */
  proc sql noprint;
    select distinct &groupvar into :groupval1 - :groupval999
    from filtered;
    %let groupcnt = &sqlobs;
  quit;

  /* Step 3: Start PDF */
  ods pdf file="fraud_score_dashboard_&groupvar..pdf" notoc dpi=300 style=journal;
  ods graphics / reset width=12in height=6in imagemap;

  %do i = 1 %to &groupcnt;
    %let thisval = &&groupval&i;
    %let title_label = %upcase(&groupvar)=&&groupval&i;

    /* Step 4: Compute fraud rates separately for each score */
    proc sql;
      create table plot_ml as
      select ML_score_bucket as score_bucket length=20,
             sum(fraud_txn) as fraud_txn,
             sum(total_txn) as total_txn,
             100 * calculated fraud_txn / calculated total_txn as fraud_rate,
             "&thisval" as &groupvar,
             "ML_Score" as score_name
      from filtered
      where &groupvar = "&thisval"
      group by ML_score_bucket;

      create table plot_sas as
      select SAS50 as score_bucket length=20,
             sum(fraud_txn) as fraud_txn,
             sum(total_txn) as total_txn,
             100 * calculated fraud_txn / calculated total_txn as fraud_rate,
             "&thisval" as &groupvar,
             "SAS50" as score_name
      from filtered
      where &groupvar = "&thisval"
      group by SAS50;

      create table plot_network as
      select Network_Score as score_bucket length=20,
             sum(fraud_txn) as fraud_txn,
             sum(total_txn) as total_txn,
             100 * calculated fraud_txn / calculated total_txn as fraud_rate,
             "&thisval" as &groupvar,
             "Network_Score" as score_name
      from filtered
      where &groupvar = "&thisval"
      group by Network_Score;
    quit;

    /* Step 5: Merge the three score plots */
    data plot_all;
      set plot_ml plot_sas plot_network;
    run;

    /* Step 6: Plot */
    title "Fraud Rate by Score Bucket - &title_label";
    proc sgplot data=plot_all;
      series x=score_bucket y=fraud_rate / group=score_name markers
             lineattrs=(pattern=solid thickness=2) datalabel datalabelpos=top;
      xaxis label="Score Bucket" discreteorder=data fitpolicy=rotate;
      yaxis label="Fraud Rate (%)" grid;
      keylegend / title="Score";
    run;

  %end;

  ods pdf close;
  title;

%mend;
