%macro plot_fraud_by_group(groupvar=, rev_type_list=);

  /* Step 1: Filter for desired rev_type values */
  data filtered;
    set your_sql_summary;
    where upcase(rev_type) in (&rev_type_list);
  run;

  /* Step 2: Extract all unique values of the grouping variable */
  proc sql noprint;
    select distinct &groupvar into :groupval1 - :groupval999
    from filtered;
    %let groupcnt = &sqlobs;
  quit;

  /* Step 3: Prepare long format */
  data long_format;
    set filtered;
    length score_name $20 score_bucket $20;

    array scores{3} $20 _temporary_ ('Network_Score', 'ML_Score', 'SAS50');
    array buckets{3} $20 Network_Score ML_score_bucket SAS50;

    do i = 1 to 3;
      score_name = scores{i};
      score_bucket = buckets{i};
      bucket_order = input(score_bucket, best12.);
      fraud_rate_unit = unit_fraud_rate * 100;
      fraud_rate_dollar = dollar_fraud_rate * 100;
      fraud_txn_cnt = fraud_txn;
      fraud_amt = fraud_dollar;
      total_amt = total_dollar;
      total_txn = total_txn;
      output;
    end;
    drop i Network_Score ML_score_bucket SAS50;
  run;

  /* Step 4: Total-level volume percentage */
  proc sql;
    create table totals as
    select &groupvar, score_name,
           sum(total_txn) as total_txn_sum,
           sum(total_amt) as total_amt_sum
    from long_format
    group by &groupvar, score_name;
  quit;

  proc sql;
    create table final_plot as
    select a.*,
           100 * a.total_txn / b.total_txn_sum as vol_pct,
           100 * a.total_amt / b.total_amt_sum as dollar_vol_pct
    from long_format a
    left join totals b
      on a.&groupvar = b.&groupvar and a.score_name = b.score_name;
  quit;

  /* Step 5: Export to PDF */
  ods pdf file="fraud_dashboard_&groupvar..pdf" notoc dpi=300 style=journal;
  ods graphics / reset width=12in height=6in imagemap;

  %do i = 1 %to &groupcnt;
    %let thisval = &&groupval&i;
    %let labeltxt = %sysfunc(propcase(&thisval));
    %let title_prefix = %upcase(&groupvar) = &labeltxt;

    /* Step 6: Pre-aggregate chart data */
    proc sql;
      create table chart_data as
      select 
        &groupvar,
        score_name,
        score_bucket,
        mean(fraud_rate_unit) as fraud_rate_unit,
        mean(fraud_rate_dollar) as fraud_rate_dollar,
        sum(fraud_txn_cnt) as fraud_txn_cnt,
        sum(fraud_amt) as fraud_amt,
        mean(vol_pct) as vol_pct,
        mean(dollar_vol_pct) as dollar_vol_pct
      from final_plot
      where &groupvar = "&thisval"
      group by &groupvar, score_name, score_bucket;
    quit;

    /* Sanity check */
    proc print data=chart_data (obs=5); title "Preview: &groupvar = &thisval"; run;

    /* --- Chart 1: Unit Fraud Rate --- */
    title "Unit Fraud Rate (%) - &title_prefix";
    proc sgplot data=chart_data;
      series x=score_bucket y=fraud_rate_unit / group=score_name markers 
             lineattrs=(pattern=solid thickness=2) datalabel datalabelpos=top;
      xaxis label="Score Bucket" discreteorder=data fitpolicy=rotate;
      yaxis label="Unit Fraud Rate (%)" grid;
      keylegend / title="Score";
    run;

    /* --- Chart 2: Dollar Fraud Rate --- */
    title "Dollar Fraud Rate (%) - &title_prefix";
    proc sgplot data=chart_data;
      series x=score_bucket y=fraud_rate_dollar / group=score_name markers 
             lineattrs=(pattern=solid thickness=2) datalabel datalabelpos=top;
      xaxis label="Score Bucket" discreteorder=data fitpolicy=rotate;
      yaxis label="Dollar Fraud Rate (%)" grid;
      keylegend / title="Score";
    run;

    /* --- Chart 3: Transaction Volume Share --- */
    title "Transaction Volume Share (%) - &title_prefix";
    proc sgplot data=chart_data;
      vbar score_bucket / response=vol_pct group=score_name groupdisplay=cluster 
           datalabel datalabelpos=top;
      xaxis label="Score Bucket" discreteorder=data fitpolicy=rotate;
      yaxis label="Volume Share (%)" grid;
      keylegend / title="Score";
    run;

    /* --- Chart 4: Dollar Volume Share --- */
    title "Dollar Volume Share (%) - &title_prefix";
    proc sgplot data=chart_data;
      vbar score_bucket / response=dollar_vol_pct group=score_name groupdisplay=cluster 
           datalabel datalabelpos=top;
      xaxis label="Score Bucket" discreteorder=data fitpolicy=rotate;
      yaxis label="Dollar Volume Share (%)" grid;
      keylegend / title="Score";
    run;

    /* --- Chart 5: Fraud Transaction Count --- */
    title "Fraud Transaction Count - &title_prefix";
    proc sgplot data=chart_data;
      vbar score_bucket / response=fraud_txn_cnt group=score_name groupdisplay=cluster 
           datalabel datalabelpos=top;
      xaxis label="Score Bucket" discreteorder=data fitpolicy=rotate;
      yaxis label="Fraud Transactions" grid;
      keylegend / title="Score";
    run;

    /* --- Chart 6: Fraud Dollar Count --- */
    title "Fraud Dollar Count - &title_prefix";
    proc sgplot data=chart_data;
      series x=score_bucket y=fraud_amt / group=score_name markers 
             lineattrs=(pattern=solid thickness=2) datalabel datalabelpos=top;
      xaxis label="Score Bucket" discreteorder=data fitpolicy=rotate;
      yaxis label="Fraud Amount ($)" grid;
      keylegend / title="Score";
    run;

  %end;

  ods pdf close;
  title;

%mend;
